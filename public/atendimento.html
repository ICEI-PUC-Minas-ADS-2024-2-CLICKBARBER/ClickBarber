<!DOCTYPE html>
<html class="dark" lang="pt-br">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Novo Atendimento</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#aa0911",
                        "background-light": "#f8f5f6",
                        "background-dark": "#181111",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"]
                    }
                },
            },
        };
    </script>
</head>

<body class="bg-background-dark font-display text-white">
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-[#221011] p-4 flex flex-col">
            <h1 class="text-xl font-extrabold mb-6">Barber Shop</h1>
            <nav class="flex flex-col gap-2">
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/30" href="#">
                    <span class="material-symbols-outlined">dashboard</span> Dashboard
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/30" href="#">
                    <span class="material-symbols-outlined">calendar_month</span> Agenda
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-primary" href="#">
                    <span class="material-symbols-outlined">content_cut</span> Atendimentos
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/30" href="#">
                    <span class="material-symbols-outlined">group</span> Clientes
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/30" href="#">
                    <span class="material-symbols-outlined">payments</span> Financeiro
                </a>
            </nav>
        </aside>

        <!-- Main -->
        <main class="flex-1 p-10">
            <h1 class="text-4xl font-black mb-8">Novo Atendimento</h1>

            <!-- Card Detalhes -->
            <div class="bg-[#221011] border border-[#543b3c] rounded-xl p-6 mb-8">
                <h2 class="text-xl font-bold mb-4">Detalhes</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Cliente -->
                    <div>
                        <label class="block mb-1 text-sm font-medium">Selecionar Cliente</label>
                        <select id="cliente" class="w-full bg-[#392829] rounded-lg p-3 text-white">
                            <option value="">Selecione</option>
                        </select>
                    </div>

                    <!-- Barbeiro -->
                    <div>
                        <label class="block mb-1 text-sm font-medium">Selecionar Barbeiro</label>
                        <select id="barbeiro" class="w-full bg-[#392829] rounded-lg p-3 text-white">
                            <option value="">Selecione</option>
                        </select>
                    </div>

                    <!-- Servi√ßos MULTIPLOS -->
                    <div class="md:col-span-2">
                        <label class="block mb-1 text-sm font-medium">Selecionar Servi√ßos</label>
                        <select id="servico" multiple class="w-full bg-[#392829] rounded-lg p-3 text-white h-40"></select>
                        <p class="text-sm opacity-60 mt-1">*Selecione v√°rios segurando CTRL.</p>
                    </div>
                </div>
            </div>

            <!-- Pagamento -->
            <div class="bg-[#221011] border border-[#543b3c] rounded-xl p-6 mb-8">
                <h2 class="text-xl font-bold mb-4">Forma de Pagamento</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button id="pg-dinheiro"
                        class="btn-pagamento bg-[#392829] py-4 rounded-lg text-center hover:bg-primary/30 flex flex-col items-center gap-2"
                        onclick="selecionarPagamento('dinheiro')">üíµ Dinheiro</button>
                    <button id="pg-pix"
                        class="btn-pagamento bg-[#392829] py-4 rounded-lg text-center hover:bg-primary/30 flex flex-col items-center gap-2"
                        onclick="selecionarPagamento('pix')">‚ö° Pix</button>
                    <button id="pg-credito"
                        class="btn-pagamento bg-[#392829] py-4 rounded-lg text-center hover:bg-primary/30 flex flex-col items-center gap-2"
                        onclick="selecionarPagamento('credito')">üí≥ Cr√©dito</button>
                    <button id="pg-debito"
                        class="btn-pagamento bg-[#392829] py-4 rounded-lg text-center hover:bg-primary/30 flex flex-col items-center gap-2"
                        onclick="selecionarPagamento('debito')">üèß D√©bito</button>
                </div>
            </div>

            <!-- Total -->
            <div class="flex justify-between items-center mb-6">
                <p class="text-xl font-bold">
                    Total: <span id="valor" class="text-primary">R$ 00,00</span>
                </p>
                <span id="statusAtendimento"
                    class="text-sm px-3 py-1 bg-yellow-500/20 text-yellow-300 rounded-lg">Aguardando</span>
            </div>

            <!-- Bot√µes -->
            <div class="flex gap-4">
                <button id="btnIniciar"
                    onclick="iniciarAtendimento()"
                    class="bg-primary px-6 py-3 rounded-lg text-lg font-bold hover:bg-primary/80">
                    Iniciar Atendimento
                </button>

                <button id="btnFinalizar"
                    class="bg-gray-700 px-6 py-3 rounded-lg text-lg font-bold opacity-40 cursor-not-allowed">
                    Finalizar Atendimento
                </button>
            </div>
        </main>
    </div>

    <!-- JS -->
    <script>
        const API = "http://localhost:3002";
        let listaServicos = [];        // servi√ßos do barbeiro selecionado
        let listaBarbeiros = [];       // cache dos barbeiros carregados
        let formaPagamento = null;

        /* =============================
            CARREGAR CLIENTES
        ============================== */
        async function carregarClientes() {
            try {
                const res = await fetch(`${API}/clientes`);
                const data = await res.json();
                const select = document.getElementById("cliente");
                select.innerHTML = `<option value="">Selecione</option>`;
                data.forEach(p => {
                    select.innerHTML += `<option value="${p.id_pessoa}">${p.Nome}</option>`;
                });
            } catch (err) {
                console.error("Erro ao carregar clientes:", err);
            }
        }
        carregarClientes();

        /* =============================
            CARREGAR BARBEIROS (VIEW)
        ============================== */
        async function carregarBarbeiros() {
            try {
                const res = await fetch(`${API}/barbeiros`);
                const data = await res.json();
                listaBarbeiros = data;

                const select = document.getElementById("barbeiro");
                select.innerHTML = `<option value="">Selecione</option>`;

                data.forEach(b => {
                    select.innerHTML += `<option value="${b.id_barbeiro}">${b.nome}</option>`;
                });
            } catch (err) {
                console.error("Erro ao carregar barbeiros:", err);
            }
        }
        carregarBarbeiros();

        /* Quando escolher barbeiro, popula servi√ßos daquele barbeiro */
        document.getElementById("barbeiro").addEventListener("change", async () => {
            const id = document.getElementById("barbeiro").value;
            const select = document.getElementById("servico");
            select.innerHTML = "";

            if (!id) {
                listaServicos = [];
                atualizarValorDisplay(0);
                return;
            }

            const barbeiro = listaBarbeiros.find(b => String(b.id_barbeiro) === String(id));
            if (!barbeiro) {
                listaServicos = [];
                atualizarValorDisplay(0);
                return;
            }

            // a view j√° devolve os servi√ßos como array (objetos com id, nome, preco)
            listaServicos = barbeiro.servicos || [];

            // popular select de servi√ßos
            if (listaServicos.length === 0) {
                select.innerHTML = `<option value="">(sem servi√ßos)</option>`;
                atualizarValorDisplay(0);
                return;
            }

            listaServicos.forEach(s => {
                // campos: s.id, s.nome, s.preco
                select.innerHTML += `<option value="${s.id}">${s.nome} - R$ ${Number(s.preco).toFixed(2).replace(".", ",")}</option>`;
            });

            atualizarTotal(); // recalcula caso algo j√° esteja selecionado
        });

        /* =============================
            CALCULAR TOTAL
        ============================== */
        document.getElementById("servico").addEventListener("change", atualizarTotal);

        function atualizarTotal() {
            const selecionados = Array.from(
                document.getElementById("servico").selectedOptions
            ).map(opt => Number(opt.value));

            const total = listaServicos
                .filter(s => selecionados.includes(Number(s.id)))
                .reduce((acc, s) => acc + Number(s.preco), 0);

            atualizarValorDisplay(total);
        }

        function atualizarValorDisplay(total) {
            document.getElementById("valor").textContent =
                "R$ " + total.toFixed(2).replace(".", ",");
        }

        /* =============================
            FORMA DE PAGAMENTO
        ============================== */
        function selecionarPagamento(tipo) {
            formaPagamento = tipo;

            document.querySelectorAll(".btn-pagamento").forEach(btn => {
                btn.classList.remove("bg-primary", "ring-2", "ring-primary");
                btn.classList.add("bg-[#392829]");
            });

            const btn = document.getElementById("pg-" + tipo);
            if (btn) {
                btn.classList.remove("bg-[#392829]");
                btn.classList.add("bg-primary", "ring-2", "ring-primary");
            }
        }

        /* =============================
            INICIAR ATENDIMENTO
        ============================== */
        async function iniciarAtendimento() {
            const id_pessoa = document.getElementById("cliente").value;
            const id_barbeiro = document.getElementById("barbeiro").value;

            // Extrai os servi√ßos selecionados com seus dados completos
            const servicosSelecionados = Array.from(
                document.getElementById("servico").selectedOptions
            ).map(opt => {
                const id = Number(opt.value);
                const textoCompleto = opt.textContent;
                
                // Extrai nome e pre√ßo do texto (formato: "Nome - R$ 00,00")
                const partes = textoCompleto.split(" - R$ ");
                const nome = partes[0];
                const preco = partes.length > 1 ? Number(partes[1].replace(",", ".")) : 0;
                
                return {
                    id: id,
                    nome: nome,
                    preco: preco
                };
            });

            const idsServicos = servicosSelecionados.map(s => s.id);
            const nomesServicos = servicosSelecionados.map(s => s.nome);

            // pega valor do display (formatado)
            const valorTexto = document.getElementById("valor").textContent
                .replace("R$ ", "")
                .replace(".", "")
                .replace(",", ".");

            const valor_total = Number(valorTexto) || 0;

            if (!id_pessoa || !id_barbeiro || idsServicos.length === 0) {
                alert("Preencha todos os campos!");
                return;
            }

            if (!formaPagamento) {
                alert("Selecione a forma de pagamento!");
                return;
            }

            // BODY FINAL
            const body = {
                id_pessoa,
                id_barbeiro,
                servicos: servicosSelecionados,  // Array completo com id, nome, preco
                valor_total,
                forma_pagamento: formaPagamento,
                nome_servicos: nomesServicos.join(", ")  // String com nomes separados por v√≠rgula
            };

            try {
                const res = await fetch(`${API}/atendimentos`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(body)
                });

                const data = await res.json();

                if (res.ok) {
                    alert("Atendimento criado! ID: " + data.id_atendimento);
                    // Resetar formul√°rio
                    document.getElementById("cliente").value = "";
                    document.getElementById("barbeiro").value = "";
                    document.getElementById("servico").innerHTML = "";
                    listaServicos = [];
                    atualizarValorDisplay(0);
                    formaPagamento = null;
                    document.querySelectorAll(".btn-pagamento").forEach(btn => {
                        btn.classList.remove("bg-primary", "ring-2", "ring-primary");
                        btn.classList.add("bg-[#392829]");
                    });
                } else {
                    alert("Erro: " + (data.erro || JSON.stringify(data)));
                }
            } catch (err) {
                console.error("Erro ao criar atendimento:", err);
                alert("Erro ao criar atendimento. Veja o console.");
            }
        }
    </script>
</body>
</html>